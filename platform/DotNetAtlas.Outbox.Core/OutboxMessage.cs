namespace DotNetAtlas.Outbox.Core;

/// <summary>
/// Represents an outbox message for reliable event publishing.
/// Includes distributed tracing support via W3C Trace Context.
/// </summary>
public class OutboxMessage
{
    /// <summary>
    /// PK, Identity.
    /// </summary>
    public long Id { get; set; }

    /// <summary>
    /// Kafka Key - typically the Aggregate ID for proper event ordering and partitioning.
    /// </summary>
    public required string? KafkaKey { get; set; }

    /// <summary>
    /// Avro-serialized domain event payload.
    /// </summary>
    public required byte[] AvroPayload { get; set; }

    /// <summary>
    /// Avro type name of the serialized event (e.g., 'FeedbackChangedEvent') used for type-based topic routing.
    /// </summary>
    public required string Type { get; set; }

    /// <summary>
    /// Headers for distributed tracing and message metadata using OpenTelemetry standards.
    /// Stored as JSON dictionary with W3C Trace Context and OpenTelemetry baggage format.
    ///
    /// Standard OpenTelemetry headers (automatically generated by Propagators.DefaultTextMapPropagator):
    /// - "traceparent": W3C Trace Context for distributed tracing (format: "00-{trace-id}-{span-id}-{trace-flags}")
    /// - "tracestate": W3C Trace Context vendor-specific state (if present)
    /// - "baggage": OpenTelemetry baggage in standard format (e.g., "user.id=0001,correlation.id=abc123")
    ///
    /// Headers are created using OutboxMessageExtensions.BuildOtelHeadersFromActivity() which uses
    /// OpenTelemetry's standard propagator.
    ///
    /// Use OutboxMessageExtensions.DeserializeHeaders() to parse back to Dictionary&lt;string, string&gt;.
    /// </summary>
    /// <example>
    /// {"traceparent":"00-95de13dcbfd2f5c71a8352dc63a09ff5-0bd65f13f80f7d13-01","baggage":"user.id=john.doe,correlation.id=abc123"}.
    /// </example>
    public string? Headers { get; set; }

    /// <summary>
    /// UTC timestamp when this message was created.
    /// </summary>
    public required DateTimeOffset CreatedUtc { get; set; }
}
