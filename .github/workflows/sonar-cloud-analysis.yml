name: Reusable - SonarCloud Analysis

on:
  workflow_call:
    secrets:
      SONAR_TOKEN:
        required: true

jobs:
  sonar-cloud-analysis:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.sha }}
      - name: Setup .NET SDK (10.0.100-rc.1.25451.107)
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5
        with:
          dotnet-version: "10.0.100-rc.1.25451.107"
          cache: true
          cache-dependency-path: "**/packages.lock.json"
      - name: Download coverage artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        continue-on-error: true
        with:
          name: coverage
          path: ${{ runner.temp }}/coveragereport
      - name: Resolve coverage arg
        run: |
          if [ -s "$RUNNER_TEMP/coveragereport/OpenCover.xml" ]; then
            echo "COVERAGE_ARG=/d:sonar.cs.opencover.reportsPaths=$RUNNER_TEMP/coveragereport/OpenCover.xml" >> $GITHUB_ENV
          else
            echo "No OpenCover.xml found; proceeding without coverage"
          fi
      - name: Cache SonarQube Cloud packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache SonarQube Cloud scanner
        id: cache-sonar-scanner
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ runner.temp }}/scanner
          key: ${{ runner.os }}-sonar-scanner
          restore-keys: ${{ runner.os }}-sonar-scanner
      - name: Install SonarQube Cloud scanner
        if: steps.cache-sonar-scanner.outputs.cache-hit != 'true'
        run: |
          mkdir -p "${{ runner.temp }}/scanner"
          dotnet tool update dotnet-sonarscanner --tool-path "${{ runner.temp }}/scanner"
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          "${{ runner.temp }}/scanner/dotnet-sonarscanner" begin /k:"DavidCapcuch_DotNetAtlas" /o:"davidcapcuch" /d:sonar.token="$SONAR_TOKEN" ${COVERAGE_ARG}
          dotnet build -c Release -p:OpenApiGenerateDocuments=false
          "${{ runner.temp }}/scanner/dotnet-sonarscanner" end /d:sonar.token="$SONAR_TOKEN"
